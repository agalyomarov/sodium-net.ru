var mongoose   = require('mongoose');
var should     = require('should');
var utils      = require('./utils');
var sinon      = require('sinon');
var Randomizer = require('../lib/randomizer');

describe('randomizerTest', function () {

    before(function(done){
        utils.setDb(done);
    });

    it('should always execute when the probability is 100%', function (done) {
        Randomizer.every(10).times.outOf(10).times.execute(function () {
            done();
        });
    });

    it('should not execute when the probability is not set correctly', function () {
        (function(){
            Randomizer.every(10).times.execute(function () {});
        }).should.throw();
        (function(){
            Randomizer.outOf(10).times.execute(function () {});
        }).should.throw();
    });

    it('should throw an exception when one of the probability values are not set', function (done) {
        (function(){
            throw new Error('fail');
        }).should.throw();
        done();
    });

    var getFakeMath = function (fakeRandVal) {
        var fakeMath = {};
        fakeMath.random = function () {
            return fakeRandVal;
        };
        return fakeMath;
    };

    it('should execute when the random value is lower than the probability', function (done) {
        Randomizer.Math = getFakeMath(0.4);
        Randomizer.every(5).outOf(10).times.execute(function () {
            done();
        });
    });

    it('should not execute when the random value is higher than the probability', function () {
        Randomizer.Math = getFakeMath(0.9);
        var spy = sinon.spy();
        var proxy = Randomizer.every(89).outOf(100).times.execute(spy);
        spy.called.should.be.false;
    });

    it('should execute only during day time', function (done) {
        Randomizer.getCurrentHour = function () {
            return 18;
        };
        Randomizer.ifItsDayTime.execute(function () {
            done();
        });
    });

    it('should execute only during night time', function (done) {
        Randomizer.getCurrentHour = function () {
            return 23;
        };
        Randomizer.ifItsNightTime.execute(function () {
            done();
        });
    });

    it('should allow to change day time definition hours', function (done) {
        Randomizer.defineDayTime({
            'from' : 11,
            'to'   : 20,
        });
        Randomizer.getCurrentHour = function () {
            return 12;
        };
        Randomizer.ifItsDayTime.execute(function () {
            done();
        });
    });

    after(function(done){
        utils.cleanDb(done);
    });

});
